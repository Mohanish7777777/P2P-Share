<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC File Transfer</title>
</head>
<body>
    <h1>WebRTC File Transfer</h1>
    
    <div>
        <label for="fileInput">Select a file to send:</label>
        <input type="file" id="fileInput">
        <button id="sendFileBtn">Send File</button>
    </div>

    <div>
        <button id="createOfferBtn">Create Offer</button>
        <button id="createAnswerBtn">Create Answer</button>
        <textarea id="offerAnswerTextarea" placeholder="Paste Offer/Answer here"></textarea>
        <button id="setOfferAnswerBtn">Set Offer/Answer</button>
    </div>

    <pre id="log"></pre>

    <script>
        const log = msg => document.getElementById('log').innerText += msg + '\n';

        let localConnection, dataChannel, remoteConnection;

        const fileInput = document.getElementById('fileInput');
        const sendFileBtn = document.getElementById('sendFileBtn');

        // Create WebRTC Connection
        const setupConnection = async () => {
            const signalingUrl = 'https://img.mohanishx1.workers.dev';
            const signaling = new WebSocket(signalingUrl);

            localConnection = new RTCPeerConnection();

            dataChannel = localConnection.createDataChannel("fileTransfer");
            dataChannel.onopen = () => log("Data Channel Opened");
            dataChannel.onmessage = event => {
                const receivedFile = event.data;
                log(`Received file of size ${receivedFile.size}`);
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(receivedFile);
                downloadLink.download = 'received-file';
                downloadLink.innerText = 'Download received file';
                document.body.appendChild(downloadLink);
            };

            // Set up WebRTC Negotiation
            localConnection.onicecandidate = e => {
                if (e.candidate) {
                    signaling.send(JSON.stringify({ candidate: e.candidate }));
                }
            };

            signaling.onmessage = async (event) => {
                const message = JSON.parse(event.data);
                if (message.offer) {
                    log("Received Offer");
                    await localConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                    const answer = await localConnection.createAnswer();
                    await localConnection.setLocalDescription(answer);
                    signaling.send(JSON.stringify({ answer }));
                } else if (message.answer) {
                    log("Received Answer");
                    await localConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                } else if (message.candidate) {
                    log("Received ICE Candidate");
                    await localConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                }
            };

            return signaling;
        };

        document.getElementById('createOfferBtn').addEventListener('click', async () => {
            const signaling = await setupConnection();
            const offer = await localConnection.createOffer();
            await localConnection.setLocalDescription(offer);
            signaling.send(JSON.stringify({ offer }));
            log(`Offer created: ${JSON.stringify(offer)}`);
        });

        document.getElementById('setOfferAnswerBtn').addEventListener('click', async () => {
            const signaling = await setupConnection();
            const offerAnswerTextarea = document.getElementById('offerAnswerTextarea').value;
            const parsedMessage = JSON.parse(offerAnswerTextarea);
            if (parsedMessage.answer) {
                await localConnection.setRemoteDescription(new RTCSessionDescription(parsedMessage.answer));
            }
        });

        sendFileBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (file) {
                dataChannel.send(file);
                log(`Sent file of size ${file.size}`);
            } else {
                log('No file selected');
            }
        });
    </script>
</body>
</html>
