<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P File Sharing</title>
</head>
<body>
    <input type="file" id="fileInput">
    <button id="connectBtn">Connect and Share File</button>
    <script>
        const fileInput = document.getElementById('fileInput');
        const connectBtn = document.getElementById('connectBtn');

        let peerConnection;
        const sessionId = 'your-session-id';  // Replace with a unique session ID
        const signalingServer = 'https://dlxx.mohanishx1.workers.dev/';  // Your CF Worker URL

        // Initialize WebRTC connection
        function initWebRTC() {
            peerConnection = new RTCPeerConnection();

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    sendSignalingData({ candidate: event.candidate });
                }
            };

            peerConnection.ondatachannel = event => {
                const receiveChannel = event.channel;
                receiveChannel.onmessage = e => {
                    console.log('Received file chunk:', e.data);
                    // Here you can handle received file data
                };
            };

            return peerConnection.createDataChannel('fileTransfer');
        }

        // Send signaling data to the Cloudflare Worker
        async function sendSignalingData(data) {
            await fetch(`${signalingServer}?session=${sessionId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
        }

        // Get signaling data from the Cloudflare Worker
        async function getSignalingData() {
            const response = await fetch(`${signalingServer}?session=${sessionId}`);
            if (response.status === 200) {
                const data = await response.json();
                if (data.sdp) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                    if (data.sdp.type === 'offer') {
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        sendSignalingData({ sdp: peerConnection.localDescription });
                    }
                } else if (data.candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            }
        }

        // Handle file selection and sending
        connectBtn.onclick = async () => {
            const dataChannel = initWebRTC();

            // Create an offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            sendSignalingData({ sdp: peerConnection.localDescription });

            // Fetch signaling data (from the other peer)
            await getSignalingData();

            // Send file data over WebRTC when ready
            dataChannel.onopen = () => {
                const file = fileInput.files[0];
                if (file) {
                    const chunkSize = 16384;
                    let offset = 0;
                    const reader = new FileReader();

                    reader.onload = e => {
                        dataChannel.send(e.target.result);
                        offset += e.target.result.byteLength;
                        if (offset < file.size) {
                            readSlice(offset);
                        }
                    };

                    const readSlice = o => {
                        const slice = file.slice(offset, o + chunkSize);
                        reader.readAsArrayBuffer(slice);
                    };

                    readSlice(0);
                }
            };
        };
    </script>
</body>
</html>
