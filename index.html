<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="https://static-00.iconduck.com/assets.00/webrtc-icon-512x496-cef4xjw5.png"
      type="image/x-icon"
    />
    <link
      rel="icon"
      href="https://static-00.iconduck.com/assets.00/webrtc-icon-512x496-cef4xjw5.png"
      type="image/x-icon"
    />
    <title>Playground | WebRTC</title>
  </head>
  <body>
    <style>
      body {
        padding: 20px;
      }
    </style>

    <h1>P2P File Transfer (WebRTC)</h1>
    <p id="connectionStatus">Not connected to peer.</p>
    <div>
      <input type="text" id="password" placeholder="Enter password" />
    </div>
    <ul style="font-size: 14px; line-height: 1.9; margin-top: 20px">
      <li>Step 1: Open this page in 2 tabs</li>
      <li>Step 2: Enter the same password in both tabs</li>
      <li>Step 3: Click on Create Offer in the first tab and Connect in the second tab</li>
    </ul>

    <div style="display: flex; align-items: center; width: 100%">
      <div style="width: 50%; background-color: beige; padding: 20px">
        <h2>Local</h2>
        <textarea id="localConfigText" cols="50" rows="15"></textarea>
        <button id="connectLocalConfig">Create local offer</button>
      </div>

      <div style="width: 50%; padding: 20px; background: beige">
        <h2>Remote</h2>
        <textarea id="remoteConfigText" cols="50" rows="15" disabled></textarea>
        <button id="connectRemoteConfig">Connect</button>
      </div>
    </div>

    <br />
    <hr />
    <br />

    <div>
      <input type="file" id="file-upload" />
      <button hidden id="sendFile">Send file</button><br />
      <progress id="progress" value="0"></progress>&nbsp;&nbsp;<label
        id="progressLabel"
      ></label>
    </div>

    <br />
    <hr />
    <br />

    <small id="progress"></small>
    <a href="" id="downloadanchor"></a>
    <button hidden id="createBlob">Create blob</button>

    <script>
      const remoteConnectBtn = document.getElementById("connectRemoteConfig");
      const localConnectBtn = document.getElementById("connectLocalConfig");
      const remoteConfigText = document.getElementById("remoteConfigText");
      const fileUpload = document.getElementById("file-upload");
      const sendFileBtn = document.getElementById("sendFile");
      const downloadAnchor = document.getElementById("downloadanchor");
      const progressbar = document.getElementById("progress");
      const progressLabel = document.getElementById("progressLabel");

      const passwordInput = document.getElementById("password");
      const apiBaseUrl = "https://your-cloudflare-worker-url.workers.dev";

      let localPeer = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:freestun.net:3479" },
          {
            urls: "turn:freestun.net:3479",
            username: "free",
            credential: "free",
          },
        ],
      });

      let dataChannel;
      let receiveBuffer = [];
      let receivedSize = 0;

      let receivedFile = {};

      localConnectBtn.addEventListener("click", async function () {
        if (!passwordInput.value) {
          alert("Please enter a password!");
          return;
        }

        dataChannel = localPeer.createDataChannel("dataChannel");
        dataChannel.binaryType = "arraybuffer";
        dataChannel.onmessage = (msg) => onReceiveMessageCallback(msg);
        dataChannel.bufferedAmountLowThreshold = 0;
        dataChannel.onopen = () =>
          (document.getElementById("connectionStatus").innerHTML =
            "Connected to peer.");

        localPeer.onicecandidate = async (o) => {
          if (localPeer.localDescription) {
            document.querySelector("#localConfigText").value = JSON.stringify(
              localPeer.localDescription
            );

            await fetch(`${apiBaseUrl}/offer`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                password: passwordInput.value,
                offer: localPeer.localDescription,
              }),
            });
          }
        };

        const localOffer = await localPeer.createOffer();
        await localPeer.setLocalDescription(new RTCSessionDescription(localOffer));
      });

      remoteConnectBtn.addEventListener("click", async function () {
        if (!passwordInput.value) {
          alert("Please enter a password!");
          return;
        }

        const offerResponse = await fetch(
          `${apiBaseUrl}/offer?password=${passwordInput.value}`
        );
        const { offer } = await offerResponse.json();

        await localPeer.setRemoteDescription(new RTCSessionDescription(offer));
        const localAnswer = await localPeer.createAnswer();
        await localPeer.setLocalDescription(localAnswer);

        await fetch(`${apiBaseUrl}/answer`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            password: passwordInput.value,
            answer: localPeer
